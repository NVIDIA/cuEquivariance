name: Nightly Full Tests

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to check for recent commits
    - name: Check for recent changes
      id: check
      run: |
        # Check if there are any commits in the last 24 hours
        RECENT_COMMITS=$(git log --since="24 hours ago" --oneline | wc -l)
        echo "Recent commits in last 24h: $RECENT_COMMITS"
        
        if [ "$RECENT_COMMITS" -gt 0 ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "Found recent changes, will run full tests"
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "No recent changes, skipping tests"
        fi

  cuequivariance-full:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance
      with:
        install-graphviz: 'true'
    
    - name: Test with pytest (including slow tests)
      run: |
        pytest --doctest-modules -x cuequivariance
    
    - name: Downgrade numpy
      run: |
        python -m uv pip install -U "numpy==1.26.*"
    
    - name: Test with pytest (numpy 1.26, including slow tests)
      run: |
        pytest --doctest-modules -x cuequivariance

  cuequivariance-jax-full:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.14"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance-jax
    
    - name: Test with pytest (including slow tests)
      run: |
        XLA_PYTHON_CLIENT_PREALLOCATE=false pytest --doctest-modules -x cuequivariance_jax

  cuequivariance-torch-full:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance-torch
    
    - name: Test with pytest (including slow tests)
      run: |
        pytest --doctest-modules -x cuequivariance_torch

  notify-on-failure:
    needs: [check-changes, cuequivariance-full, cuequivariance-jax-full, cuequivariance-torch-full]
    if: always() && needs.check-changes.outputs.should_run == 'true' && (needs.cuequivariance-full.result == 'failure' || needs.cuequivariance-jax-full.result == 'failure' || needs.cuequivariance-torch-full.result == 'failure')
    runs-on: ubuntu-latest
    steps:
    - name: Create Issue on Failure
      uses: actions/github-script@v7
      env:
        CUEQUIVARIANCE_FULL_RESULT: ${{ needs.cuequivariance-full.result }}
        CUEQUIVARIANCE_JAX_FULL_RESULT: ${{ needs.cuequivariance-jax-full.result }}
        CUEQUIVARIANCE_TORCH_FULL_RESULT: ${{ needs.cuequivariance-torch-full.result }}
      with:
        script: |
          const title = `üö® Nightly Tests Failed - ${new Date().toISOString().split('T')[0]}`;
          
          const failedJobs = [];
          if (process.env.CUEQUIVARIANCE_FULL_RESULT === 'failure') {
            failedJobs.push('‚ùå cuequivariance-full');
          }
          if (process.env.CUEQUIVARIANCE_JAX_FULL_RESULT === 'failure') {
            failedJobs.push('‚ùå cuequivariance-jax-full');
          }
          if (process.env.CUEQUIVARIANCE_TORCH_FULL_RESULT === 'failure') {
            failedJobs.push('‚ùå cuequivariance-torch-full');
          }
          
          const body = `## Nightly Test Failure Report
          
          **Date:** ${new Date().toISOString()}
          **Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### Failed Jobs:
          ${failedJobs.join('\n')}
          
          Please investigate and fix the failing tests.
          
          ---
          *This issue was automatically created by the nightly test workflow.*`;
          
          // Check if there's already an open issue for nightly test failures
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'nightly-test-failure'
          });
          
          if (issues.length === 0) {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['nightly-test-failure', 'bug']
            });
          } else {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues[0].number,
              body: `## New Failure Report\n\n${body}`
            });
          } 

  close-failure-issues:
    needs: [check-changes, cuequivariance-full, cuequivariance-jax-full, cuequivariance-torch-full]
    if: always() && needs.check-changes.outputs.should_run == 'true' && needs.cuequivariance-full.result == 'success' && needs.cuequivariance-jax-full.result == 'success' && needs.cuequivariance-torch-full.result == 'success'
    runs-on: ubuntu-latest
    steps:
    - name: Close Failure Issues
      uses: actions/github-script@v7
      with:
        script: |
          // Find open nightly test failure issues
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'nightly-test-failure'
          });
          
          // Close them with a success comment
          for (const issue of issues) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `‚úÖ **Tests are now passing!**\n\nNightly tests passed on ${new Date().toISOString().split('T')[0]}.\nWorkflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\nClosing this issue automatically.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
          } 
