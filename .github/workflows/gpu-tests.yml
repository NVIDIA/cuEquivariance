name: Tests on GPUs

on:
  push:
    branches:
      - "main"
      - "release"
      - "pull-request/[0-9]+"

jobs:

  jax-gpu:
    runs-on: linux-amd64-gpu-l4-latest-1
    
    steps:

    - name: Collect System and Hardware Information
      run: |
        uname -a
        cat /etc/os-release
        lscpu | head -20
        free -h
        df -h
        nvidia-smi

    - uses: actions/checkout@v5
    - uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade uv
        python -m uv pip install -U pytest "jax[cuda12]"
        # python -m uv pip install nvidia-cusolver-cu12==11.7.3.90
        python -m uv pip install nvidia-cublas-cu12
        python -m uv pip install jax-triton triton==3.3.1
        # python -m uv pip uninstall cuequivariance cuequivariance_jax cuequivariance_torch
        python -m uv pip install cuequivariance-ops-cu12 cuequivariance-ops-jax-cu12
        python -m uv pip install -e ./cuequivariance
        python -m uv pip install -e ./cuequivariance_jax

        python -c "import cuequivariance; print('cue', cuequivariance.__version__)"
        python -c "import cuequivariance_jax; print('cuex', cuequivariance_jax.__version__)"

        
    - name: Test with pytest
      run: |
        XLA_PYTHON_CLIENT_PREALLOCATE=false pytest --doctest-modules -x -m "not slow" cuequivariance_jax
