name: Run Tests

on:
  push:
    branches: [ "main", "release" ]
  pull_request:
    branches: [ "main", "release" ]


jobs:

  cuequivariance:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance
      with:
        install-graphviz: 'true'
    
    - name: Test with pytest
      run: |
        pytest --doctest-modules -x -m "not slow" cuequivariance
    
    - name: Downgrade numpy
      run: |
        python -m uv pip install -U "numpy==1.26.*"
    
    - name: Test with pytest (numpy 1.26)
      run: |
        pytest --doctest-modules -x -m "not slow" cuequivariance


  cuequivariance-jax:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.13"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance-jax
    
    - name: Test with pytest
      run: |
        XLA_PYTHON_CLIENT_PREALLOCATE=false pytest --doctest-modules -x -m "not slow" cuequivariance_jax


  cuequivariance-jax-no-flax:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: "3.12"
    
    - name: Install without flax
      run: |
        python -m uv pip install -U jax
        python -m uv pip install -e ./cuequivariance
        python -m uv pip install -e ./cuequivariance_jax
    
    - name: Verify import without flax
      run: |
        python -c "import cuequivariance_jax; print('cuex', cuequivariance_jax.__version__)"
        python -c "import cuequivariance_jax.nnx; print('nnx module imported')"
        python -c "import cuequivariance_jax.flax_linen; print('flax_linen module imported')"


  cuequivariance-torch:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
    
    - uses: ./.github/actions/setup-cuequivariance-torch
    
    - name: Test with pytest
      run: |
        pytest --doctest-modules -x -m "not slow" cuequivariance_torch
